{% extends "base.html" %}

{% block title %}Contract Details - GigUp{% endblock %}

{% block content %}
<div id="contractContainer">
    <p>Loading contract details...</p>
</div>

<!-- Signature Pad Modal -->
<div id="signatureModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 500px;">
        <h3>Sign Contract</h3>
        <p>Draw your signature in the box below:</p>
        
        <canvas id="signaturePad" width="400" height="200" style="border: 1px solid #ddd; border-radius: 5px; cursor: crosshair;"></canvas>
        
        <div style="display: flex; gap: 0.5rem; margin: 1rem 0;">
            <button onclick="clearSignature()" class="btn" style="background: #6c757d;">
                <i class="fas fa-eraser"></i> Clear
            </button>
            <button onclick="saveSignature()" class="btn" style="background: #28a745;">
                <i class="fas fa-check"></i> Save Signature
            </button>
            <button onclick="closeSignatureModal()" class="btn" style="background: #dc3545;">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>

<script>
    let currentContract = null;
    let currentSigner = null;
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    async function loadContractDetail() {
        const contractId = window.location.pathname.split('/').pop();
        
        try {
            const response = await fetch(`/api/contracts/${contractId}`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                displayContractDetail(data.contract);
            } else {
                showContractNotFound();
            }
        } catch (error) {
            console.error('Error loading contract:', error);
            showContractNotFound();
        }
    }

    function displayContractDetail(contract) {
        currentContract = contract;
        const container = document.getElementById('contractContainer');
        
        // Get current user ID from session (you might need to adjust this based on your auth system)
        const currentUserId = parseInt('{{ session.get("user_id", 0) }}') || 0;
        
        const isProvider = contract.provider_id === currentUserId;
        const isSeeker = contract.seeker_id === currentUserId;
        const canSign = (isProvider && !contract.provider_signature) || (isSeeker && !contract.seeker_signature);
        const canManage = isProvider || isSeeker;
        
        container.innerHTML = `
            <div style="max-width: 800px; margin: 0 auto;">
                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <!-- Contract Header -->
                    <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #667eea; padding-bottom: 1rem;">
                        <h1 style="color: #333; margin-bottom: 0.5rem;">GigUp Contract Agreement</h1>
                        <p style="color: #666; font-size: 1.1rem;">${contract.title}</p>
                        <p style="color: #999; font-size: 0.9rem;">Contract ID: ${contract.id}</p>
                    </div>

                    <!-- Contract Parties -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h3 style="color: #333; margin-bottom: 1rem;">Provider</h3>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                                <p><strong>Name:</strong> ${contract.provider_name}</p>
                                <p><strong>Email:</strong> ${contract.provider_email}</p>
                                <p><strong>Role:</strong> Service Provider</p>
                                ${contract.provider_signature ? `
                                    <p><strong>Signature:</strong> <span style="color: #28a745;">✓ Signed</span></p>
                                    <p><small>Signed on: ${contract.signed_at ? new Date(contract.signed_at).toLocaleDateString() : 'Date not available'}</small></p>
                                ` : `
                                    <p><strong>Signature:</strong> <span style="color: #dc3545;">Pending</span></p>
                                `}
                            </div>
                        </div>
                        
                        <div>
                            <h3 style="color: #333; margin-bottom: 1rem;">Seeker</h3>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                                <p><strong>Name:</strong> ${contract.seeker_name}</p>
                                <p><strong>Email:</strong> ${contract.seeker_email}</p>
                                <p><strong>Role:</strong> Service Seeker</p>
                                ${contract.seeker_signature ? `
                                    <p><strong>Signature:</strong> <span style="color: #28a745;">✓ Signed</span></p>
                                    <p><small>Signed on: ${contract.signed_at ? new Date(contract.signed_at).toLocaleDateString() : 'Date not available'}</small></p>
                                ` : `
                                    <p><strong>Signature:</strong> <span style="color: #dc3545;">Pending</span></p>
                                `}
                            </div>
                        </div>
                    </div>

                    <!-- Contract Details -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #333; margin-bottom: 1rem;">Contract Details</h3>
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 5px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div>
                                    <strong>Gig:</strong> ${contract.title}
                                </div>
                                <div>
                                    <strong>Pay Amount:</strong> $${contract.pay}
                                </div>
                                ${contract.hours ? `<div><strong>Hours:</strong> ${contract.hours} hours</div>` : ''}
                                <div>
                                    <strong>Contract Date:</strong> ${new Date(contract.date).toLocaleDateString()}
                                </div>
                                <div>
                                    <strong>Status:</strong> 
                                    <span style="color: ${contract.status === 'signed' ? '#28a745' : contract.status === 'pending' ? '#ffc107' : '#dc3545'};">
                                        ${contract.status.toUpperCase()}
                                    </span>
                                </div>
                                <div>
                                    <strong>Created:</strong> ${new Date(contract.created_at).toLocaleDateString()}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contract Terms -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #333; margin-bottom: 1rem;">Terms & Conditions</h3>
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 5px; line-height: 1.6; white-space: pre-wrap;">
                            ${contract.terms || `This contract formalizes the agreement between the Provider and Seeker for the gig "${contract.title}".

Responsibilities:
• Provider agrees to deliver the services as described in the gig
• Seeker agrees to provide necessary information and cooperation  
• Both parties agree to maintain professional conduct

Payment:
• Amount: $${contract.pay}
• Payment due upon satisfactory completion of services

Dispute Resolution:
• Any disputes will be mediated through GigUp platform
• Both parties agree to communicate professionally to resolve issues`}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="text-align: center; margin-top: 2rem;">
                        ${canSign ? `
                            <button onclick="openSignatureModal(${isProvider})" class="btn" style="background: #28a745; padding: 1rem 2rem; font-size: 1.1rem; margin: 0.5rem;">
                                <i class="fas fa-signature"></i> Sign Contract as ${isProvider ? 'Provider' : 'Seeker'}
                            </button>
                        ` : ''}
                        
                        ${canManage && contract.status === 'signed' ? `
                            <button onclick="completeContract()" class="btn" style="background: #17a2b8; padding: 1rem 2rem; font-size: 1.1rem; margin: 0.5rem;">
                                <i class="fas fa-check-circle"></i> Mark as Completed
                            </button>
                        ` : ''}
                        
                        ${canManage && contract.status === 'pending' ? `
                            <button onclick="cancelContract()" class="btn" style="background: #dc3545; padding: 1rem 2rem; font-size: 1.1rem; margin: 0.5rem;">
                                <i class="fas fa-times"></i> Cancel Contract
                            </button>
                        ` : ''}
                        
                        ${contract.status === 'signed' ? `
                            <button onclick="downloadContract()" class="btn" style="background: #6c757d; padding: 1rem 2rem; font-size: 1.1rem; margin: 0.5rem;">
                                <i class="fas fa-download"></i> Download Contract
                            </button>
                        ` : ''}
                        
                        <a href="/my-gigs" class="btn" style="background: #6c757d; padding: 1rem 2rem; font-size: 1.1rem; margin: 0.5rem;">
                            <i class="fas fa-arrow-left"></i> Back to My Gigs
                        </a>
                    </div>

                    <!-- Signatures Display -->
                    ${contract.status === 'signed' ? `
                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #dee2e6;">
                            <h3 style="color: #333; margin-bottom: 1rem; text-align: center;">Digital Signatures</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                <div style="text-align: center;">
                                    <h4>Provider Signature</h4>
                                    ${contract.provider_signature ? `
                                        <img src="${contract.provider_signature}" style="max-width: 200px; border: 1px solid #ddd; border-radius: 5px; background: white;">
                                        <p><small>${contract.provider_name}</small></p>
                                    ` : '<p style="color: #dc3545;">Not signed</p>'}
                                </div>
                                <div style="text-align: center;">
                                    <h4>Seeker Signature</h4>
                                    ${contract.seeker_signature ? `
                                        <img src="${contract.seeker_signature}" style="max-width: 200px; border: 1px solid #ddd; border-radius: 5px; background: white;">
                                        <p><small>${contract.seeker_name}</small></p>
                                    ` : '<p style="color: #dc3545;">Not signed</p>'}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    function showContractNotFound() {
        document.getElementById('contractContainer').innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <h2>Contract Not Found</h2>
                <p>The contract you're looking for doesn't exist or you don't have permission to view it.</p>
                <a href="/my-gigs" class="btn">Back to My Gigs</a>
            </div>
        `;
    }

    // Signature functionality
    function openSignatureModal(isProvider) {
        currentSigner = isProvider ? 'provider' : 'seeker';
        document.getElementById('signatureModal').style.display = 'flex';
        
        // Initialize signature pad
        const canvas = document.getElementById('signaturePad');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        
        // Reset drawing state
        isDrawing = false;
        lastX = 0;
        lastY = 0;

        // Mouse events
        canvas.onmousedown = startDrawing;
        canvas.onmousemove = draw;
        canvas.onmouseup = stopDrawing;
        canvas.onmouseout = stopDrawing;

        // Touch events for mobile
        canvas.ontouchstart = (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        };

        canvas.ontouchmove = (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        };

        canvas.ontouchend = () => {
            const mouseEvent = new MouseEvent('mouseup', {});
            canvas.dispatchEvent(mouseEvent);
        };
    }

    function startDrawing(e) {
        isDrawing = true;
        const rect = e.target.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
    }

    function draw(e) {
        if (!isDrawing) return;
        const canvas = e.target;
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
        
        lastX = currentX;
        lastY = currentY;
    }

    function stopDrawing() {
        isDrawing = false;
    }

    function clearSignature() {
        const canvas = document.getElementById('signaturePad');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function closeSignatureModal() {
        document.getElementById('signatureModal').style.display = 'none';
        currentSigner = null;
    }

    async function saveSignature() {
        const canvas = document.getElementById('signaturePad');
        
        // Check if signature is not empty
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const isEmpty = !imageData.data.some(channel => channel !== 0);
        
        if (isEmpty) {
            showAlert('Please provide a signature before saving.', 'error');
            return;
        }

        const signatureData = canvas.toDataURL(); // Base64 encoded image
        
        if (!currentContract || !currentSigner) return;

        try {
            const response = await fetch(`/api/contracts/${currentContract.id}/sign`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({ signature: signatureData })
            });

            const result = await response.json();
            
            if (response.ok) {
                showAlert('Contract signed successfully!', 'success');
                closeSignatureModal();
                loadContractDetail(); // Reload to show updated status
            } else {
                showAlert('Error: ' + (result.error || 'Failed to sign contract'), 'error');
            }
        } catch (error) {
            showAlert('Network error: ' + error.message, 'error');
        }
    }

    async function completeContract() {
        if (!confirm('Are you sure you want to mark this contract as completed?')) {
            return;
        }

        try {
            const response = await fetch(`/api/contracts/${currentContract.id}/complete`, {
                method: 'PUT',
                credentials: 'include'
            });

            const result = await response.json();
            
            if (response.ok) {
                showAlert('Contract marked as completed!', 'success');
                loadContractDetail();
            } else {
                showAlert('Error: ' + (result.error || 'Failed to complete contract'), 'error');
            }
        } catch (error) {
            showAlert('Network error: ' + error.message, 'error');
        }
    }

    async function cancelContract() {
        if (!confirm('Are you sure you want to cancel this contract? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/contracts/${currentContract.id}/cancel`, {
                method: 'PUT',
                credentials: 'include'
            });

            const result = await response.json();
            
            if (response.ok) {
                showAlert('Contract cancelled successfully!', 'success');
                loadContractDetail();
            } else {
                showAlert('Error: ' + (result.error || 'Failed to cancel contract'), 'error');
            }
        } catch (error) {
            showAlert('Network error: ' + error.message, 'error');
        }
    }

    function downloadContract() {
        if (!currentContract) return;

        const contractText = `
GIGUP CONTRACT AGREEMENT
========================

Contract ID: ${currentContract.id}
Gig: ${currentContract.title}
Status: ${currentContract.status.toUpperCase()}

PARTIES:
--------
Provider: ${currentContract.provider_name}
Email: ${currentContract.provider_email}
Signature: ${currentContract.provider_signature ? 'SIGNED' : 'PENDING'}

Seeker: ${currentContract.seeker_name}  
Email: ${currentContract.seeker_email}
Signature: ${currentContract.seeker_signature ? 'SIGNED' : 'PENDING'}

CONTRACT DETAILS:
-----------------
Pay Amount: $${currentContract.pay}
${currentContract.hours ? `Hours: ${currentContract.hours}` : ''}
Contract Date: ${new Date(currentContract.date).toLocaleDateString()}
Created: ${new Date(currentContract.created_at).toLocaleDateString()}
${currentContract.signed_at ? `Signed: ${new Date(currentContract.signed_at).toLocaleDateString()}` : ''}

TERMS & CONDITIONS:
-------------------
${currentContract.terms || 'Standard GigUp contract terms apply.'}

This contract was generated by GigUp on ${new Date().toLocaleDateString()}.
        `;

        const blob = new Blob([contractText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `gigup-contract-${currentContract.id}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Load contract when page loads
    loadContractDetail();
</script>
{% endblock %}